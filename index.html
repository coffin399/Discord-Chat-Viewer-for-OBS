<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Chat Viewer for OBS - リアルタイムチャット表示ツール</title>
  <meta name="description" content="Discord Chat Viewer for OBSは、DiscordのチャットをOBS Studioでリアルタイム表示できるツールです。配信者向けのチャット表示ソリューション。">
  <meta name="keywords" content="Discord, OBS, 配信, チャット, リアルタイム, ストリーミング, 配信ツール, Discord Chat Viewer">
  <meta name="author" content="Discord Chat Viewer for OBS">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://discord-chat-viewer-obs.com/">
  <meta property="og:title" content="Discord Chat Viewer for OBS - リアルタイムチャット表示ツール">
  <meta property="og:description" content="Discord Chat Viewer for OBSは、DiscordのチャットをOBS Studioでリアルタイム表示できるツールです。配信者向けのチャット表示ソリューション。">
  <meta property="og:image" content="https://discord-chat-viewer-obs.com/og-image.jpg">
  <meta property="og:site_name" content="Discord Chat Viewer for OBS">
  <meta property="og:locale" content="ja_JP">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://discord-chat-viewer-obs.com/">
  <meta property="twitter:title" content="Discord Chat Viewer for OBS - リアルタイムチャット表示ツール">
  <meta property="twitter:description" content="Discord Chat Viewer for OBSは、DiscordのチャットをOBS Studioでリアルタイム表示できるツールです。配信者向けのチャット表示ソリューション。">
  <meta property="twitter:image" content="https://discord-chat-viewer-obs.com/og-image.jpg">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://discord-chat-viewer-obs.com/">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Discord Chat Viewer for OBS",
    "description": "Discord Chat Viewer for OBSは、DiscordのチャットをOBS Studioでリアルタイム表示できるツールです。配信者向けのチャット表示ソリューション。",
    "url": "https://discord-chat-viewer-obs.com/",
    "applicationCategory": "MultimediaApplication",
    "operatingSystem": "Windows, macOS, Linux",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "JPY"
    },
    "author": {
      "@type": "Organization",
      "name": "Discord Chat Viewer for OBS"
    },
    "datePublished": "2024-01-01",
    "dateModified": "2025-10-26"
  }
  </script>
  
  <style id="custom-fonts"></style>
  <style>
    :root {
      --chat-font: 'CustomFont', 'Yu Gothic', 'Meiryo', 'MS Gothic', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--chat-font);
      background-color: #cceeff;
      background-image:
        radial-gradient(#ffffff 10%, transparent 11%),
        radial-gradient(#ffffff 10%, transparent 11%);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
    }

    #chat {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .message {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .message .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .message-content {
      background: #ffe6f2;
      border: 3px solid #ffb6c1;
      border-radius: 25px;
      padding: 12px 16px;
      color: #ff69b4;
      font-family: var(--chat-font);
      margin-left: 8px;
      max-width: 70%;
      margin-right: auto;
      position: relative;
      margin-bottom: 0;
      box-shadow:
        0 0 15px rgba(255,182,193,0.6),
        0 0 30px rgba(255,182,193,0.4),
        0 0 45px rgba(255,182,193,0.2);
    }

    .message-content::after {
      content: "";
      position: absolute;
      top: 12px;
      left: -10px;
      border-width: 15px 15px 0;
      border-style: solid;
      border-color: #ffe6f2 transparent transparent transparent;
      filter: drop-shadow(0 -2px 2px rgba(255,182,193,0.4));
    }

    .author {
      font-family: var(--chat-font);
      font-weight: bold;
      color: black;
      margin-right: 6px;
    }

    .text {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .attachment-img, .embed-img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 6px;
      border-radius: 10px;
    }

    .attachment-video, .embed-video {
      max-width: 100%;
      display: block;
      margin-top: 6px;
      border-radius: 10px;
    }

    .attachment-link {
      display: block;
      margin-top: 6px;
      color: #ff69b4;
      text-decoration: underline;
      word-break: break-all;
    }

    .embed {
      border: 2px dashed #ffb6c1;
      border-radius: 12px;
      padding: 8px;
      margin-top: 8px;
      background: #fff0f6;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .embed-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .embed-description {
      margin-bottom: 4px;
    }

    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #ffb6c1;
      border-radius: 15px;
      font-size: 12px;
      color: #ff69b4;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="status">接続中...</div>
  <div id="chat"></div>

  <script>
    const chat = document.getElementById("chat");
    const statusDiv = document.getElementById("status");
    const customFontsStyle = document.getElementById("custom-fonts");
    let socket = null;
    let reconnectInterval = 1000;
    const maxReconnectInterval = 30000;
    let reconnectTimer = null;
    let isIntentionallyClosed = false;

    // WebSocketのURLを動的に決定
    const wsUrl = (() => {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.hostname || 'localhost';
      return `${protocol}//${host}:8765`;
    })();

    console.log('WebSocket URL:', wsUrl);

    function updateStatus(message, color = '#ff69b4') {
      statusDiv.textContent = message;
      statusDiv.style.color = color;
      console.log('Status:', message);
    }

    function loadCustomFonts(fontFiles) {
      if (!fontFiles || fontFiles.length === 0) {
        console.log('📝 カスタムフォントなし。デフォルトフォントを使用します');
        return;
      }

      let fontFaceRules = '';
      fontFiles.forEach((font, index) => {
        const fontName = font.name || `CustomFont${index}`;
        const format = font.format || 'truetype';

        fontFaceRules += `
          @font-face {
            font-family: '${fontName}';
            src: url(data:${font.mime};base64,${font.data}) format('${format}');
            font-weight: normal;
            font-style: normal;
          }
        `;

        console.log(`✅ フォント登録: ${fontName}`);
      });

      customFontsStyle.textContent = fontFaceRules;

      // 最初のフォントをメインフォントとして設定
      if (fontFiles.length > 0) {
        const firstFont = fontFiles[0].name || 'CustomFont0';
        document.documentElement.style.setProperty('--chat-font',
          `'${firstFont}', 'Yu Gothic', 'Meiryo', 'MS Gothic', sans-serif`);
        console.log(`✅ メインフォント設定: ${firstFont}`);
      }
    }

    function connect() {
      if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
        console.log("既に接続中またはオープン状態です");
        return;
      }

      try {
        updateStatus("接続中...", "#ff69b4");
        console.log('接続試行:', wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          console.log("✅ WebSocket connected!");
          updateStatus("接続完了", "#00cc00");
          reconnectInterval = 1000;
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };

        socket.onmessage = event => {
          console.log('📨 メッセージ受信:', event.data.substring(0, 100));
          try {
            const data = JSON.parse(event.data);

            if (data.type === "init") {
              console.log("📋 初期データ受信:", data.messages.length, "件のメッセージ");
              loadCustomFonts(data.fonts);
              chat.innerHTML = "";
              data.messages.forEach(renderMessage);
              chat.scrollTop = chat.scrollHeight;
              updateStatus("準備完了", "#00cc00");
            }

            if (data.type === "new") {
              console.log("🆕 新しいメッセージ受信");
              renderMessage(data.message);
              chat.scrollTop = chat.scrollHeight;
            }
          } catch (error) {
            console.error("❌ メッセージ解析エラー:", error);
            console.error("受信データ:", event.data);
          }
        };

        socket.onerror = (error) => {
          console.error("❌ WebSocket Error:", error);
          console.error("エラー詳細:", {
            readyState: socket.readyState,
            url: socket.url
          });
          updateStatus("エラー発生", "#ff0000");
        };

        socket.onclose = (event) => {
          console.log("❌ WebSocket disconnected.");
          console.log("切断情報:", {
            code: event.code,
            reason: event.reason,
            wasClean: event.wasClean
          });

          if (!isIntentionallyClosed) {
            updateStatus(`切断 (${reconnectInterval/1000}秒後に再接続...)`, "#ff6600");

            reconnectTimer = setTimeout(() => {
              reconnectInterval = Math.min(reconnectInterval * 1.5, maxReconnectInterval);
              console.log("🔄 再接続を試みます...");
              connect();
            }, reconnectInterval);
          }
        };

      } catch (error) {
        console.error("❌ 接続エラー:", error);
        updateStatus("接続失敗", "#ff0000");
      }
    }

    function getFileExtension(url) {
      if (!url) return '';
      const pathname = new URL(url).pathname;
      const ext = pathname.split('.').pop().toLowerCase();
      return ext;
    }

    function renderMessage(m) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
      avatar.alt = m.author;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      const authorSpan = document.createElement('span');
      authorSpan.className = 'author';
      authorSpan.textContent = m.author;

      const textSpan = document.createElement('span');
      textSpan.className = 'text';
      textSpan.textContent = m.content;

      contentDiv.appendChild(authorSpan);
      contentDiv.appendChild(textSpan);

      // 添付ファイルの処理
      if (m.attachments && m.attachments.length > 0) {
        m.attachments.forEach(att => {
          const ext = getFileExtension(att.url);
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext);
          const isVideo = ['mp4', 'webm', 'mov'].includes(ext);

          if (isImage) {
            const img = document.createElement('img');
            img.className = 'attachment-img';
            img.src = att.url;
            img.alt = att.filename;
            contentDiv.appendChild(img);
          } else if (isVideo) {
            const video = document.createElement('video');
            video.className = 'attachment-video';
            video.src = att.url;
            video.controls = true;
            contentDiv.appendChild(video);
          } else {
            const link = document.createElement('a');
            link.className = 'attachment-link';
            link.href = att.url;
            link.target = '_blank';
            link.textContent = `📎 ${att.filename}`;
            contentDiv.appendChild(link);
          }
        });
      }

      // Embedsの処理
      if (m.embeds && m.embeds.length > 0) {
        m.embeds.forEach(embed => {
          const embedDiv = document.createElement('div');
          embedDiv.className = 'embed';

          if (embed.title) {
            const title = document.createElement('div');
            title.className = 'embed-title';
            title.textContent = embed.title;
            embedDiv.appendChild(title);
          }

          if (embed.description) {
            const desc = document.createElement('div');
            desc.className = 'embed-description';
            desc.textContent = embed.description;
            embedDiv.appendChild(desc);
          }

          if (embed.image) {
            const img = document.createElement('img');
            img.className = 'embed-img';
            img.src = embed.image;
            embedDiv.appendChild(img);
          }

          contentDiv.appendChild(embedDiv);
        });
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chat.appendChild(messageDiv);
    }

    window.addEventListener('beforeunload', () => {
      isIntentionallyClosed = true;
      if (socket) {
        socket.close();
      }
    });

    // ページ読み込み完了後に接続
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', connect);
    } else {
      connect();
    }
  </script>
</body>
</html>